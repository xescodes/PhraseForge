<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phrase Forge</title>
    <style>
        /* --- Variables Globales --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --text-color: #212529;
            --border-color: #ced4da;
            --card-bg: #ffffff;
            --error-color: #dc3545; /* Rojo para errores y botones de limpiar */
            --success-color: #28a745; /* Verde para éxito */
            --warning-color: #ffc107; /* Amarillo para advertencias */
            --button-hover-primary: #0056b3;
            --button-hover-success: #218838;
            --button-hover-error: #c82333;
            --disabled-color: #adb5bd;
        }

        /* --- Estilos Base --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* --- Contenedor Principal --- */
        .container {
            max-width: 900px;
            margin: 20px auto; /* Añadido margen superior/inferior */
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Sombra más pronunciada */
        }

        /* --- Encabezados --- */
        h1, h2 {
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0; /* Quitar margen superior por defecto */
            margin-bottom: 25px;
        }
        h1 {
            text-align: center;
            margin-bottom: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2em; /* Tamaño de fuente más grande */
        }
        h2 {
             margin-top: 30px; /* Espacio antes de las secciones */
             font-size: 1.6em;
        }

        /* --- Icono del Título (SVG) --- */
        .title-icon {
            width: 40px;
            height: 40px;
            margin-right: 12px;
            fill: currentColor; /* Usa el color del texto circundante */
        }

        /* --- Sección de Clave API --- */
        .api-key-section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #eef2f7; /* Fondo ligeramente diferente */
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        .api-key-section label {
            font-weight: bold;
            margin-bottom: 8px; /* Más espacio */
            display: block; /* Asegura que ocupe su línea */
            color: var(--secondary-color);
        }
        .api-key-input-wrapper { /* Contenedor para input y botones */
            display: flex;
            align-items: center;
            gap: 10px; /* Espacio entre elementos */
            margin-bottom: 10px; /* Espacio antes del estado */
        }
        .api-key-section input[type="password"],
        .api-key-section input[type="text"] {
            flex-grow: 1; /* Ocupa el espacio disponible */
            padding: 10px; /* Padding consistente */
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .api-key-section button {
            padding: 10px 15px; /* Padding consistente */
            font-size: 0.95rem;
            white-space: nowrap; /* Evita que el texto del botón se rompa */
        }
        #api-key-status {
            font-size: 0.9em;
            margin-top: 8px;
            min-height: 1.2em; /* Evita saltos de layout */
        }
        .api-key-section p { /* Estilo para el enlace a OpenRouter */
             font-size: 0.85em;
             margin-top: 10px;
             color: var(--secondary-color);
        }
         .api-key-section a {
             color: var(--primary-color);
             text-decoration: none;
         }
         .api-key-section a:hover {
             text-decoration: underline;
         }

        /* --- Estilos de Formularios --- */
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 0.95em;
        }
        textarea,
        select,
        input[type="range"] {
            width: 100%;
            padding: 12px; /* Más padding */
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: var(--card-bg); /* Fondo blanco */
            color: var(--text-color);
        }
        textarea {
            min-height: 120px; /* Más altura mínima */
            resize: vertical;
        }
        select {
             appearance: none; /* Quitar estilo por defecto */
            -webkit-appearance: none;
            -moz-appearance: none;
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
             background-repeat: no-repeat;
             background-position: right 12px center;
             background-size: 12px 12px;
             padding-right: 40px; /* Espacio para la flecha */
        }
        input[type="range"] {
            cursor: pointer;
            height: 8px;
            background: #e9ecef; /* Fondo más claro */
            border-radius: 5px;
            appearance: none;
            -webkit-appearance: none;
            padding: 0; /* Quitar padding vertical */
            margin-top: 5px; /* Espacio sobre el slider */
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            margin-top: -6px; /* Centrar verticalmente */
            border: none; /* Quitar borde por defecto */
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); /* Sombra sutil */
        }
        input[type="range"]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* --- Estilo de Botones --- */
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500; /* Ligeramente más grueso */
            cursor: pointer;
            transition: background-color 0.2s ease, opacity 0.2s ease;
            margin-right: 10px;
            margin-top: 10px; /* Asegura espacio si se apilan */
            vertical-align: middle;
        }
        button:last-child {
             margin-right: 0; /* Quitar margen al último botón de un grupo */
        }
        button:hover:not(:disabled) {
            background-color: var(--button-hover-primary);
        }
        button:disabled {
            background-color: var(--disabled-color); /* Color grisáceo */
            cursor: not-allowed;
            opacity: 0.7;
        }
        #export-btn { background-color: var(--success-color); }
        #export-btn:hover:not(:disabled) { background-color: var(--button-hover-success); }
        #clear-history-btn, #clear-result-btn, #clear-key-btn { background-color: var(--error-color); }
        #clear-history-btn:hover:not(:disabled),
        #clear-result-btn:hover:not(:disabled),
        #clear-key-btn:hover:not(:disabled) { background-color: var(--button-hover-error); }

        /* --- Secciones de Resultado e Historial --- */
        .result-section, .history-section { margin-top: 40px; }
        .result-section .button-group { margin-top: 15px; } /* Grupo para botones de resultado */
        #result {
            min-height: 250px; /* Tamaño por defecto más grande */
            background-color: #f1f3f5; /* Fondo ligeramente diferente */
            font-family: "Menlo", "Consolas", monospace; /* Fuente monoespaciada */
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px; /* Más padding interno */
            width: 100%;
            box-sizing: border-box;
            font-size: 0.95em; /* Ligeramente más pequeño */
            line-height: 1.5; /* Mejor espaciado de línea */
        }
        #history-list {
            max-height: 350px; /* Un poco más alto */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 10px; /* Menos padding exterior */
            border-radius: 4px;
            background-color: var(--background-color); /* Fondo del body */
        }
        .history-item {
            background-color: var(--card-bg);
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 10px; /* Menos espacio entre items */
            border-radius: 4px;
            cursor: pointer;
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
            position: relative; /* Para posible futuro icono de borrar */
        }
        .history-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color); /* Resaltar al pasar el ratón */
        }
        .history-item strong {
            display: block;
            margin-bottom: 5px;
            color: var(--primary-color);
            font-size: 0.9em;
            font-weight: 600;
        }
        .history-item p { /* Para el snippet del resultado */
            margin: 5px 0;
            font-size: 0.9em;
            color: #555;
            max-height: 60px; /* Limitar altura */
            overflow: hidden;
            text-overflow: ellipsis;
            /* white-space: pre-wrap; No es ideal para snippets */
            word-wrap: break-word;
            line-height: 1.4;
        }
        .history-meta {
            font-size: 0.8em;
            color: var(--secondary-color);
            margin-top: 10px;
            border-top: 1px dashed var(--border-color); /* Separador */
            padding-top: 8px;
        }
        .history-item .truncated-indicator { /* Estilo para el indicador de truncado */
            color: var(--warning-color);
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 5px;
        }

        /* --- Indicadores de Carga y Mensajes --- */
        #loading {
            display: none;
            text-align: center;
            margin: 25px 0;
            font-weight: bold;
            color: var(--secondary-color);
            font-style: italic;
        }
        #error-message, #warning-message {
            padding: 12px 15px;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
            font-size: 0.95em;
            border: 1px solid transparent;
        }
        #error-message {
            color: #721c24; /* Texto oscuro para contraste */
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        #warning-message {
            color: #856404; /* Texto oscuro */
            background-color: #fff3cd;
            border-color: #ffeeba;
        }

        /* --- Contenedor y Valor del Slider de Longitud --- */
        .length-container {
            display: flex;
            align-items: center;
            gap: 15px; /* Espacio entre slider y valor */
        }
        .length-container input[type="range"] {
            flex-grow: 1;
            margin: 0; /* Quitar margen por defecto */
        }
        #length-value {
            font-weight: bold;
            color: var(--primary-color);
            background-color: #e9ecef; /* Fondo para resaltar */
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            min-width: 90px; /* Ancho mínimo */
            text-align: center;
            white-space: nowrap;
        }

        /* --- Estilos Responsivos --- */
        @media (max-width: 768px) {
             .container { padding: 20px; }
             h1 { font-size: 1.9em; }
             h2 { font-size: 1.4em; }
             .api-key-input-wrapper { flex-direction: column; align-items: stretch; }
             .api-key-section button { width: 100%; margin-top: 5px; margin-right: 0; }
             .length-container { flex-direction: column; align-items: flex-start; gap: 10px;}
             .length-container input[type="range"] { width: 100%; }
             #length-value { margin-top: 5px; width: 100%; text-align: left;}
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            h1 { font-size: 1.7em; }
            h2 { font-size: 1.3em; }
            textarea { min-height: 100px; }
            #result { min-height: 200px; }
            button { width: 100%; margin-right: 0; margin-bottom: 10px; } /* Botones apilados */
            .button-group { display: flex; flex-direction: column; gap: 10px; margin-top: 10px;}
            .button-group button { margin-bottom: 0; } /* Quitar margen inferior extra */
            .api-key-input-wrapper { gap: 5px; }
            .api-key-section button { margin-top: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <svg class="title-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M19.04 6.96C17.71 5.68 15.94 5 14 5c-1.94 0-3.71.68-5.04 1.96C7.68 8.29 7 10.06 7 12s.68 3.71 1.96 5.04C10.29 18.32 12.06 19 14 19s3.71-.68 5.04-1.96C20.32 15.71 21 13.94 21 12s-.68-3.71-1.96-5.04zM14 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm-1-8v4h2V9h-2zm0 6v2h2v-2h-2z" fill-rule="evenodd"/>
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10h5v-2h-5c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8v1.43c.9.44 1.5 1.39 1.5 2.57 0 1.66-1.34 3-3 3h-2.5c-.83 0-1.5-.67-1.5-1.5S15.67 16 16.5 16H18v-2h-1.5c-1.93 0-3.5 1.57-3.5 3.5s1.57 3.5 3.5 3.5H20c2.76 0 5-2.24 5-5 0-2.05-1.23-3.81-3-4.58V12c0-5.52-4.48-10-10-10z" opacity=".3"/>
            </svg>
            Phrase Forge
        </h1>

        <div class="api-key-section">
            <label for="api-key-input">Clave API de OpenRouter:</label>
            <div class="api-key-input-wrapper">
                <input type="password" id="api-key-input" placeholder="Introduce tu clave API (sk-or-v1-...)">
                <button id="save-key-btn">Guardar Clave</button>
                <button id="clear-key-btn">Borrar Clave</button>
            </div>
            <div id="api-key-status">Introduce tu clave para activar la generación. La clave se guarda localmente.</div>
            <p>
                Consigue tu clave en <a href="https://openrouter.ai/keys" target="_blank" rel="noopener noreferrer">OpenRouter</a>.
                Phrase Forge necesita una clave válida para generar texto.
            </p>
        </div>

        <p>Genera texto de alta calidad en múltiples estilos e idiomas usando IA. Ajusta el deslizador para la longitud deseada de la *próxima* generación. Los resultados se añadirán abajo.</p>

        <div class="input-section">
            <div class="form-group">
                <label for="prompt">Introduce tu Instrucción (Prompt):</label>
                <textarea id="prompt" placeholder="Ej: Escribe una historia corta sobre un robot perdido encontrando su camino a casa"></textarea>
            </div>

            <div class="form-group">
                <label for="style">Estilo de Escritura:</label>
                <select id="style">
                    <option value="Formal">Formal</option>
                    <option value="Informal">Informal</option>
                    <option value="Persuasive">Persuasivo</option>
                    <option value="Descriptive">Descriptivo</option>
                    <option value="Narrative" selected>Narrativo</option>
                    <option value="Technical">Técnico</option>
                    <option value="Humorous">Humorístico</option>
                    <option value="Poetic">Poético</option>
                    <option value="Horror">Terror</option>
                    </select>
            </div>

            <div class="form-group">
                <label for="language">Idioma:</label>
                <select id="language">
                    <option value="Spanish">Español</option>
                    <option value="Catalan">Catalán</option>
                    <option value="English" selected>Inglés</option>
                    <option value="French">Francés</option>
                    <option value="German">Alemán</option>
                    <option value="Italian">Italiano</option>
                    <option value="Portuguese">Portugués</option>
                    <option value="Russian">Ruso</option>
                    <option value="Chinese">Chino</option>
                    <option value="Japanese">Japonés</option>
                    <option value="Korean">Coreano</option>
                     </select>
            </div>

            <div class="form-group">
                <label for="length">Longitud para la Próxima Generación (palabras aprox.):</label>
                <div class="length-container">
                    <input type="range" id="length" min="50" max="1000" step="10" value="200"> <span id="length-value">200 palabras</span>
                </div>
            </div>

            <button id="generate-btn" disabled>Generar y Añadir Texto</button>
            <div id="loading">Generando... Por favor, espera...</div>
            <div id="error-message"></div>
            <div id="warning-message"></div>
        </div>

        <div class="result-section">
            <h2>Área de Resultado</h2>
            <textarea id="result" placeholder="Introduce tu clave API arriba, luego genera texto. El texto generado por IA se añadirá aquí..." readonly></textarea> <div class="button-group">
                <button id="copy-result-btn" disabled>Copiar Texto</button> <button id="export-btn" disabled>Exportar como .txt</button>
                <button id="clear-result-btn" disabled>Limpiar Área</button>
            </div>
        </div>

        <div class="history-section">
            <h2>Historial de Generaciones (Individuales)</h2>
            <div id="history-list"><p>Aún no se han registrado generaciones individuales.</p></div>
            <button id="clear-history-btn" disabled>Limpiar Historial</button>
        </div>
    </div>

    <script>
        // --- Configuración ---
        const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        // Modelo especificado por el usuario
        const MODEL = 'meta-llama/llama-4-maverick:free';
        const MAX_HISTORY_ITEMS = 25; // Aumentado límite de historial
        const DEFAULT_MAX_TOKENS = 1500; // Aumentado para permitir respuestas más largas si es necesario
        const API_KEY_STORAGE_KEY = 'phraseForgeApiKey';
        const HISTORY_STORAGE_KEY = 'phraseForgeHistory';

        // --- Elementos DOM (Cache) ---
        const apiKeyInput = document.getElementById('api-key-input');
        const saveKeyBtn = document.getElementById('save-key-btn');
        const clearKeyBtn = document.getElementById('clear-key-btn');
        const apiKeyStatus = document.getElementById('api-key-status');
        const promptEl = document.getElementById('prompt');
        const styleEl = document.getElementById('style');
        const languageEl = document.getElementById('language');
        const lengthEl = document.getElementById('length');
        const lengthValueEl = document.getElementById('length-value');
        const generateBtn = document.getElementById('generate-btn');
        const loadingEl = document.getElementById('loading');
        const errorMessageEl = document.getElementById('error-message');
        const warningMessageEl = document.getElementById('warning-message');
        const resultEl = document.getElementById('result');
        const copyResultBtn = document.getElementById('copy-result-btn');
        const exportBtn = document.getElementById('export-btn');
        const clearResultBtn = document.getElementById('clear-result-btn');
        const historyListEl = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');

        // --- Estado de la Aplicación ---
        let currentApiKey = null;
        let isGenerating = false; // Para prevenir múltiples llamadas simultáneas

        // --- Funciones ---

        // --- Gestión de la Clave API ---
        function loadApiKey() {
            const storedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (storedKey) {
                currentApiKey = storedKey;
                apiKeyInput.value = currentApiKey; // Mostrar en el input (tipo password)
                apiKeyStatus.textContent = 'Clave API cargada desde almacenamiento local.';
                apiKeyStatus.style.color = 'var(--success-color)';
                generateBtn.disabled = false; // Habilitar generación si hay clave
            } else {
                apiKeyStatus.textContent = 'Introduce tu clave API de OpenRouter para activar la generación.';
                apiKeyStatus.style.color = 'var(--secondary-color)';
                generateBtn.disabled = true; // Deshabilitar si no hay clave
            }
            updateApiKeyButtonsState(); // Actualizar botones de clave
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            // Validación básica (debe empezar con sk-or-v1-)
            if (key && key.startsWith('sk-or-v1-')) {
                currentApiKey = key;
                localStorage.setItem(API_KEY_STORAGE_KEY, currentApiKey);
                apiKeyStatus.textContent = '¡Clave API guardada correctamente!';
                apiKeyStatus.style.color = 'var(--success-color)';
                generateBtn.disabled = isGenerating; // Habilitar si no se está generando
                hideMessage('error'); // Ocultar errores previos
            } else {
                showError("Formato de clave API inválido. Debe empezar con 'sk-or-v1-'.");
                generateBtn.disabled = true; // Mantener deshabilitado si la clave es inválida
            }
             updateApiKeyButtonsState();
        }

        function clearApiKey() {
            if (confirm('¿Estás seguro de que quieres borrar la clave API guardada? Esta acción no se puede deshacer.')) {
                currentApiKey = null;
                localStorage.removeItem(API_KEY_STORAGE_KEY);
                apiKeyInput.value = '';
                apiKeyStatus.textContent = 'Clave API borrada. Introduce una clave para activar la generación.';
                apiKeyStatus.style.color = 'var(--secondary-color)';
                generateBtn.disabled = true; // Deshabilitar generación
                updateApiKeyButtonsState();
            }
        }

         function updateApiKeyButtonsState() {
            const keyExists = !!localStorage.getItem(API_KEY_STORAGE_KEY);
            clearKeyBtn.disabled = !keyExists || isGenerating; // Deshabilitar si no hay clave o se está generando
            saveKeyBtn.disabled = isGenerating; // Deshabilitar solo si se está generando
            apiKeyInput.disabled = isGenerating; // Deshabilitar input durante la generación
        }


        // --- Actualizaciones de UI ---
        function updateLengthDisplay() {
            lengthValueEl.textContent = `${lengthEl.value} palabras`;
        }

        function showLoading(isLoading) {
            isGenerating = isLoading; // Actualizar estado global
            loadingEl.style.display = isLoading ? 'block' : 'none';

            // Deshabilitar/Habilitar elementos del formulario durante la carga
            generateBtn.disabled = isLoading || !currentApiKey;
            promptEl.disabled = isLoading;
            styleEl.disabled = isLoading;
            languageEl.disabled = isLoading;
            lengthEl.disabled = isLoading;
            updateApiKeyButtonsState(); // Actualiza estado de botones de API key

            // Ocultar mensajes al iniciar la carga
            if (isLoading) {
                hideMessage('error');
                hideMessage('warning');
            }
        }

        function showError(message) {
            errorMessageEl.textContent = `Error: ${message}`;
            errorMessageEl.style.display = 'block';
            hideMessage('warning'); // Ocultar advertencia si hay error
        }

        function showWarning(message) {
            warningMessageEl.textContent = `Advertencia: ${message}`;
            warningMessageEl.style.display = 'block';
            hideMessage('error'); // Ocultar error si hay advertencia
        }

        function hideMessage(type) {
            if (type === 'error') {
                errorMessageEl.style.display = 'none';
                errorMessageEl.textContent = '';
            } else if (type === 'warning') {
                warningMessageEl.style.display = 'none';
                warningMessageEl.textContent = '';
            }
        }

        // --- Gestión del Historial ---
        function loadHistory() {
            const history = getHistoryFromStorage();
            displayHistory(history);
            clearHistoryBtn.disabled = history.length === 0; // Habilitar/deshabilitar botón
        }

        function getHistoryFromStorage() {
            const storedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
            try {
                // Parsea el historial o devuelve un array vacío si no existe o está corrupto
                return storedHistory ? JSON.parse(storedHistory) : [];
            } catch (e) {
                console.error("Error al parsear el historial desde localStorage:", e);
                localStorage.removeItem(HISTORY_STORAGE_KEY); // Limpiar datos corruptos
                return [];
            }
        }

        function saveHistoryToStorage(history) {
            try {
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
            } catch (e) {
                 console.error("Error al guardar el historial en localStorage:", e);
                 showError("No se pudo guardar el historial, posiblemente el almacenamiento está lleno.");
            }
        }

        function addToHistory(item) {
            const history = getHistoryFromStorage();
            history.unshift(item); // Añadir al principio (más reciente primero)

            // Limitar el tamaño del historial
            if (history.length > MAX_HISTORY_ITEMS) {
                history.pop(); // Eliminar el más antiguo
            }

            saveHistoryToStorage(history);
            displayHistory(history); // Actualizar la vista del historial
            clearHistoryBtn.disabled = false; // Asegurar que el botón de limpiar esté habilitado
        }

        function displayHistory(history) {
            historyListEl.innerHTML = ''; // Limpiar vista actual
            if (history.length === 0) {
                historyListEl.innerHTML = '<p>Aún no se han registrado generaciones individuales.</p>';
                clearHistoryBtn.disabled = true;
                return;
            }

            clearHistoryBtn.disabled = false; // Habilitar botón si hay historial

            history.forEach((item, index) => {
                const div = document.createElement('div');
                div.classList.add('history-item');
                div.dataset.index = index; // Guardar índice para recuperarlo al hacer clic

                // Validar y formatear datos del historial
                const timestamp = item?.timestamp ? new Date(item.timestamp).toLocaleString() : 'N/A';

                // Función simple para escapar HTML y prevenir XSS básico
                const escapeHtml = (unsafe) => {
                    if (typeof unsafe !== 'string') return '';
                    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                };

                const promptSnippet = item?.prompt ? escapeHtml(item.prompt.substring(0, 100)) + (item.prompt.length > 100 ? '...' : '') : '[Sin Prompt]';
                const resultSnippet = item?.result ? escapeHtml(item.result.substring(0, 150)) + (item.result.length > 150 ? '...' : '') : '[Sin Resultado]';
                const style = item?.style ? escapeHtml(item.style) : 'N/A';
                const language = item?.language ? escapeHtml(item.language) : 'N/A';
                const lengthReq = item?.length ? item.length : 'N/A';
                const finishReason = item?.finish_reason;

                // Indicador si la generación pudo ser truncada
                const truncatedIndicator = (finishReason === 'length' || finishReason === 'max_tokens')
                    ? '<span class="truncated-indicator">(Podría estar truncado)</span>'
                    : '';

                // Crear HTML para el elemento del historial
                div.innerHTML = `
                    <strong>Prompt:</strong> ${promptSnippet}
                    <p><strong>Fragmento del Resultado:</strong> ${resultSnippet}${truncatedIndicator}</p>
                    <div class="history-meta">Estilo: ${style} | Idioma: ${language} | Longitud Solicitada: ${lengthReq} palabras | ${timestamp}</div>
                `;

                // Añadir listener para cargar este item al hacer clic
                div.addEventListener('click', () => loadHistoryItem(index));

                historyListEl.appendChild(div);
            });
        }

        function loadHistoryItem(index) {
             const allHistory = getHistoryFromStorage();
             const historyItem = allHistory[index];

             if (historyItem) {
                 // Restaurar los valores en los campos del formulario
                 promptEl.value = historyItem.prompt || '';
                 styleEl.value = historyItem.style || 'Narrative'; // Valor por defecto si no existe
                 languageEl.value = historyItem.language || 'English'; // Valor por defecto
                 lengthEl.value = historyItem.length || 200; // Valor por defecto
                 updateLengthDisplay(); // Actualizar el texto del slider

                 // Mostrar el resultado completo en el área de resultados
                 resultEl.value = historyItem.result || '';

                 // Habilitar/deshabilitar botones del área de resultado
                 const hasResultContent = !!historyItem.result;
                 copyResultBtn.disabled = !hasResultContent;
                 exportBtn.disabled = !hasResultContent;
                 clearResultBtn.disabled = !hasResultContent;

                 // Mostrar advertencia si fue truncado
                 if (historyItem.finish_reason === 'length' || historyItem.finish_reason === 'max_tokens') {
                     showWarning("Este texto cargado podría haber sido truncado debido a límites en la generación original.");
                 } else {
                     hideMessage('warning'); // Ocultar advertencia si no fue truncado
                 }
                 hideMessage('error'); // Ocultar errores

                 // Hacer scroll hacia el área de resultados para conveniencia
                 resultEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

             } else {
                 console.error("No se pudo recuperar el elemento del historial para el índice:", index);
                 showError("Fallo al cargar el elemento del historial seleccionado.");
             }
        }


        function clearHistory() {
            if (confirm('¿Estás seguro de que quieres borrar TODO el historial de generaciones? Esta acción no se puede deshacer.')) {
                localStorage.removeItem(HISTORY_STORAGE_KEY);
                loadHistory(); // Recargar para mostrar historial vacío y actualizar botones
            }
        }

        // --- Gestión del Área de Resultados ---
         function copyResultText() {
            if (!resultEl.value) {
                showWarning("No hay texto en el área de resultado para copiar.");
                return;
            }
            navigator.clipboard.writeText(resultEl.value)
                .then(() => {
                    // Opcional: Mostrar una confirmación temporal
                    const originalText = copyResultBtn.textContent;
                    copyResultBtn.textContent = '¡Copiado!';
                    copyResultBtn.style.backgroundColor = 'var(--success-color)';
                    setTimeout(() => {
                        copyResultBtn.textContent = originalText;
                        copyResultBtn.style.backgroundColor = ''; // Volver al color original
                    }, 2000);
                })
                .catch(err => {
                    console.error('Error al copiar texto: ', err);
                    showError('No se pudo copiar el texto al portapapeles.');
                });
        }


        function exportText() {
            const textToExport = resultEl.value;
            if (!textToExport) {
                 showWarning('¡No hay nada que exportar en el área de resultado!');
                return;
            }

            // Crear un Blob (objeto binario) con el texto
            const blob = new Blob([textToExport], { type: 'text/plain;charset=utf-8' });
            // Crear una URL temporal para el Blob
            const url = URL.createObjectURL(blob);

            // Crear un enlace invisible para iniciar la descarga
            const link = document.createElement('a');
            link.href = url;
            // Nombre del archivo sugerido
            link.download = `phrase_forge_output_${Date.now()}.txt`;

            // Simular clic en el enlace
            document.body.appendChild(link); // Necesario para Firefox
            link.click();

            // Limpiar
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Liberar la URL temporal
        }

        function clearResultArea() {
            resultEl.value = ''; // Limpiar el textarea
            // Deshabilitar botones asociados
            copyResultBtn.disabled = true;
            exportBtn.disabled = true;
            clearResultBtn.disabled = true;
            // Ocultar mensajes
            hideMessage('warning');
            hideMessage('error');
        }

        // --- Generación de Texto (Llamada API) ---
        async function generateText() {
            if (isGenerating) {
                showWarning("Ya hay una generación en progreso. Por favor, espera.");
                return;
            }

            const userPrompt = promptEl.value.trim();
            const selectedStyle = styleEl.value;
            const selectedLanguage = languageEl.value;
            const targetLength = lengthEl.value;

            // --- Validaciones Previas ---
            if (!currentApiKey) {
                showError("Falta la clave API. Por favor, introduce y guarda tu clave de OpenRouter.");
                apiKeyInput.focus(); // Poner foco en el input de la clave
                return;
            }
            if (!userPrompt) {
                showError("Por favor, introduce una instrucción (prompt).");
                promptEl.focus(); // Poner foco en el prompt
                return;
            }

            // --- Iniciar Proceso de Carga ---
            showLoading(true);
            // Deshabilitar botones de resultado mientras se genera
            copyResultBtn.disabled = true;
            exportBtn.disabled = true;
            clearResultBtn.disabled = true;

            // --- Construir Mensajes para la API ---
            // Mensaje del sistema para guiar a la IA
            const systemMessage = `Eres Phrase Forge, un asistente IA especializado en generar texto según especificaciones del usuario. Sigue las instrucciones con precisión. Responde ÚNICAMENTE con el texto solicitado en el idioma especificado. No añadas saludos, disculpas, o auto-referencias a menos que sean parte del texto solicitado. No uses markdown en la respuesta.`;

            // Mensaje del usuario con todos los detalles
            const userMessageContent = `
Genera un texto siguiendo estas especificaciones:
- **TAREA**: Escribe un texto basado en la instrucción del usuario.
- **INSTRUCCIÓN DEL USUARIO**: "${userPrompt}"
- **ESTILO DE ESCRITURA**: ${selectedStyle}
- **IDIOMA**: ${selectedLanguage}
- **NÚMERO DE PALABRAS OBJETIVO APROXIMADO**: ${targetLength} palabras.

**INSTRUCCIONES IMPORTANTES**:
1. Intenta que el número total de palabras sea **cercano a ${targetLength} palabras**, pero prioriza la **finalización natural** de frases e ideas sobre alcanzar estrictamente el número exacto.
2. Asegúrate de que el texto fluya bien y **concluya adecuadamente** con una frase o idea terminada. No cortes a mitad de frase a menos que te quedes absolutamente sin longitud de generación permitida.
3. Responde **solamente** con el texto generado, en el idioma solicitado (${selectedLanguage}). No incluyas la instrucción original ni ningún texto introductorio como "Aquí tienes el texto:".
`;

            let finishReason = null; // Para guardar por qué terminó la generación
            let generatedText = ''; // Para guardar el texto generado

            try {
                // --- Determinar Referer y Title para OpenRouter ---
                // Necesario para cumplir con los requisitos de OpenRouter
                let referer = 'http://localhost/phraseforge/unknown'; // Valor por defecto seguro
                let title = 'Phrase Forge'; // Título por defecto
                if (typeof window !== 'undefined' && window.location.href) {
                    // Si se ejecuta desde un archivo local (file://), usar un referer genérico
                    if (window.location.protocol === 'file:') {
                        referer = 'http://localhost/phraseforge/localfile';
                    } else {
                        referer = window.location.href; // Usar la URL actual si es http/https
                    }
                }
                 if (typeof document !== 'undefined' && document.title) {
                    title = document.title; // Usar el título del documento si está disponible
                 }


                // --- Realizar la Llamada Fetch a la API ---
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`, // Clave API
                        'Content-Type': 'application/json',
                        // Cabeceras requeridas por OpenRouter
                        'HTTP-Referer': referer,
                        'X-Title': title,
                    },
                    body: JSON.stringify({
                        model: MODEL, // Modelo seleccionado
                        messages: [
                            { "role": "system", "content": systemMessage },
                            { "role": "user", "content": userMessageContent }
                        ],
                        max_tokens: DEFAULT_MAX_TOKENS, // Límite máximo de tokens a generar
                        // Otros parámetros opcionales (temperature, top_p) podrían añadirse aquí
                        // temperature: 0.7, // Ejemplo: Un valor para creatividad controlada
                    }),
                });

                // --- Manejar la Respuesta de la API ---
                if (!response.ok) {
                    // Si la respuesta no es exitosa (status code no es 2xx)
                    let errorData;
                    let errorText = `Fallo en la petición API: ${response.status} ${response.statusText}.`;
                    try {
                        // Intentar parsear el cuerpo del error como JSON
                        errorData = await response.json();
                        console.error("Datos de respuesta de error API:", errorData);
                        // Extraer mensaje de error específico si está disponible
                        const detail = errorData?.error?.message || JSON.stringify(errorData.error);
                        if (detail) { errorText += ` Detalles: ${detail}`; }

                        // Añadir mensajes específicos para códigos de error comunes
                        if (response.status === 401) { errorText += " Verifica si tu clave API es válida y tiene fondos/créditos."; }
                        if (response.status === 429) { errorText += " Límite de tasa excedido (Rate Limit). Por favor, espera e inténtalo de nuevo."; }
                        if (response.status === 400 && detail && detail.includes("Invalid model")) { errorText += ` El modelo seleccionado '${MODEL}' podría ser inválido o no estar disponible. Consulta la documentación de OpenRouter.`; }
                        if (response.status === 400 && detail && detail.includes("max_tokens")) { errorText += ` El valor 'max_tokens' (${DEFAULT_MAX_TOKENS}) podría ser demasiado alto para este modelo o petición.`; }
                        if (response.status === 400 && detail && detail.includes("prompt is too long")) { errorText += ` La instrucción (prompt) es demasiado larga para el modelo. Intenta acortarla.`; }

                    } catch (e) {
                        // Si falla el parseo del JSON del error
                        console.error("Fallo al parsear JSON del error:", e);
                        errorText += " Además, no se pudo leer el detalle del error de la respuesta.";
                    }
                    // Lanzar un error para ser capturado por el bloque catch principal
                    throw new Error(errorText);
                }

                // Si la respuesta es exitosa (status code 2xx)
                const data = await response.json();

                // Extraer el texto generado y la razón de finalización
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    generatedText = data.choices[0].message.content.trim();
                    finishReason = data.choices[0].finish_reason; // 'stop', 'length', 'max_tokens', etc.
                } else {
                     // Si la respuesta es 200 OK pero no tiene el formato esperado
                    console.error("Respuesta inesperada de la API:", data);
                    throw new Error("La respuesta de la API no contenía el texto generado esperado.");
                }

                // --- Actualizar UI con el Resultado ---
                // Añadir el nuevo texto al área de resultados (añadiendo un separador si ya hay texto)
                const separator = resultEl.value ? "\n\n---\n\n" : ""; // Separador visual
                resultEl.value += separator + generatedText;

                // Hacer scroll al final del textarea para ver el nuevo texto
                resultEl.scrollTop = resultEl.scrollHeight;

                // Habilitar botones de resultado ahora que hay contenido
                copyResultBtn.disabled = false;
                exportBtn.disabled = false;
                clearResultBtn.disabled = false;

                // --- Guardar en el Historial ---
                addToHistory({
                    prompt: userPrompt,
                    style: selectedStyle,
                    language: selectedLanguage,
                    length: targetLength,
                    result: generatedText, // Guardar solo la última generación en el historial individual
                    timestamp: Date.now(),
                    finish_reason: finishReason, // Guardar por qué terminó
                    model: MODEL // Guardar el modelo usado
                });

                 // Mostrar advertencia si la generación fue truncada
                 if (finishReason === 'length' || finishReason === 'max_tokens') {
                     showWarning(`La generación pudo haber sido truncada porque alcanzó el límite de longitud (${finishReason}).`);
                 }


            } catch (error) {
                // --- Manejar Errores Generales (incluyendo los lanzados arriba) ---
                console.error("Error durante la generación de texto:", error);
                showError(error.message || "Ocurrió un error desconocido durante la generación.");
                // Asegurarse de que los botones de resultado estén deshabilitados si falló
                copyResultBtn.disabled = !resultEl.value;
                exportBtn.disabled = !resultEl.value;
                clearResultBtn.disabled = !resultEl.value;

            } finally {
                // --- Limpieza Final (siempre se ejecuta) ---
                showLoading(false); // Ocultar indicador de carga y rehabilitar controles
            }
        }

        // --- Inicialización y Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar clave API y historial al iniciar
            loadApiKey();
            loadHistory();
            updateLengthDisplay(); // Mostrar valor inicial del slider

            // Listeners para botones y controles
            saveKeyBtn.addEventListener('click', saveApiKey);
            clearKeyBtn.addEventListener('click', clearApiKey);
            apiKeyInput.addEventListener('keypress', (e) => { // Guardar con Enter en el input de clave
                 if (e.key === 'Enter') {
                     saveApiKey();
                 }
            });

            lengthEl.addEventListener('input', updateLengthDisplay); // Actualizar valor del slider en tiempo real
            generateBtn.addEventListener('click', generateText);

            copyResultBtn.addEventListener('click', copyResultText);
            exportBtn.addEventListener('click', exportText);
            clearResultBtn.addEventListener('click', clearResultArea);

            clearHistoryBtn.addEventListener('click', clearHistory);

            // Habilitar/deshabilitar botones de resultado basado en si hay contenido al cargar
             const initialResultContent = !!resultEl.value;
             copyResultBtn.disabled = !initialResultContent;
             exportBtn.disabled = !initialResultContent;
             clearResultBtn.disabled = !initialResultContent;

        });

    </script>
</body>
</html>
