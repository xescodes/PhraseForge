<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phrase Forge</title>
    <link rel="icon" href="assets/industry.ico" type="image/x-icon">
    <style>
        /* --- Variables Globales --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --text-color: #212529;
            --border-color: #ced4da;
            --card-bg: #ffffff;
            --error-color: #dc3545; /* Rojo para errores y botones de limpiar */
            --success-color: #28a745; /* Verde para éxito */
            --warning-color: #ffc107; /* Amarillo para advertencias */
            --button-hover-primary: #0056b3;
            --button-hover-success: #218838;
            --button-hover-error: #c82333;
            --disabled-color: #adb5bd;
        }

        /* --- Estilos Base --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* --- Contenedor Principal --- */
        .container {
            max-width: 900px;
            margin: 20px auto; /* Añadido margen superior/inferior */
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Sombra más pronunciada */
        }

        /* --- Encabezados --- */
        h1, h2 {
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0; /* Quitar margen superior por defecto */
            margin-bottom: 25px;
        }
        h1 {
            text-align: center;
            margin-bottom: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2em; /* Tamaño de fuente más grande */
        }
        h2 {
             margin-top: 30px; /* Espacio antes de las secciones */
             font-size: 1.6em;
        }

        /* --- Icono del Título (SVG) --- */
        .title-icon {
            width: 40px;
            height: 40px;
            margin-right: 12px;
            fill: currentColor; /* Usa el color del texto circundante */
        }

        /* --- Sección de Clave API --- */
        .api-key-section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #eef2f7; /* Fondo ligeramente diferente */
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        .api-key-section label {
            font-weight: bold;
            margin-bottom: 8px; /* Más espacio */
            display: block; /* Asegura que ocupe su línea */
            color: var(--secondary-color);
        }
        .api-key-input-wrapper { /* Contenedor para input y botones */
            display: flex;
            align-items: center;
            gap: 10px; /* Espacio entre elementos */
            margin-bottom: 10px; /* Espacio antes del estado */
        }
        .api-key-section input[type="password"],
        .api-key-section input[type="text"] { /* Permitir text para visibilidad opcional */
            flex-grow: 1; /* Ocupa el espacio disponible */
            padding: 10px; /* Padding consistente */
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .api-key-section button {
            padding: 10px 15px; /* Padding consistente */
            font-size: 0.95rem;
            white-space: nowrap; /* Evita que el texto del botón se rompa */
        }
        #api-key-status {
            font-size: 0.9em;
            margin-top: 8px;
            min-height: 1.2em; /* Evita saltos de layout */
            /* aria-live="polite" añadido en HTML */
        }
        .api-key-section p { /* Estilo para el enlace a OpenRouter */
             font-size: 0.85em;
             margin-top: 10px;
             color: var(--secondary-color);
        }
         .api-key-section a {
             color: var(--primary-color);
             text-decoration: none;
         }
         .api-key-section a:hover {
             text-decoration: underline;
         }

        /* --- Estilos de Formularios --- */
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 0.95em;
        }
        textarea,
        select,
        input[type="range"] {
            width: 100%;
            padding: 12px; /* Más padding */
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: var(--card-bg); /* Fondo blanco */
            color: var(--text-color);
        }
        textarea {
            min-height: 120px; /* Más altura mínima */
            resize: vertical;
        }
        select {
             appearance: none; /* Quitar estilo por defecto */
            -webkit-appearance: none;
            -moz-appearance: none;
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
             background-repeat: no-repeat;
             background-position: right 12px center;
             background-size: 12px 12px;
             padding-right: 40px; /* Espacio para la flecha */
        }
        input[type="range"] {
            cursor: pointer;
            height: 8px;
            background: #e9ecef; /* Fondo más claro */
            border-radius: 5px;
            appearance: none;
            -webkit-appearance: none;
            padding: 0; /* Quitar padding vertical */
            margin-top: 5px; /* Espacio sobre el slider */
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            margin-top: -6px; /* Centrar verticalmente */
            border: none; /* Quitar borde por defecto */
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); /* Sombra sutil */
        }
        input[type="range"]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* --- Estilo de Botones --- */
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500; /* Ligeramente más grueso */
            cursor: pointer;
            transition: background-color 0.2s ease, opacity 0.2s ease;
            margin-right: 10px;
            margin-top: 10px; /* Asegura espacio si se apilan */
            vertical-align: middle;
        }
        button:last-child {
             margin-right: 0; /* Quitar margen al último botón de un grupo */
        }
        button:hover:not(:disabled) {
            background-color: var(--button-hover-primary);
        }
        button:disabled {
            background-color: var(--disabled-color); /* Color grisáceo */
            cursor: not-allowed;
            opacity: 0.7;
        }
        #export-btn { background-color: var(--success-color); }
        #export-btn:hover:not(:disabled) { background-color: var(--button-hover-success); }
        #clear-history-btn, #clear-result-btn, #clear-key-btn { background-color: var(--error-color); }
        #clear-history-btn:hover:not(:disabled),
        #clear-result-btn:hover:not(:disabled),
        #clear-key-btn:hover:not(:disabled) { background-color: var(--button-hover-error); }

        /* --- Secciones de Resultado e Historial --- */
        .result-section, .history-section { margin-top: 40px; }
        .result-section .button-group { margin-top: 15px; } /* Grupo para botones de resultado */
        #result {
            min-height: 250px; /* Tamaño por defecto más grande */
            background-color: #f1f3f5; /* Fondo ligeramente diferente */
            font-family: "Menlo", "Consolas", monospace; /* Fuente monoespaciada */
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px; /* Más padding interno */
            width: 100%;
            box-sizing: border-box;
            font-size: 0.95em; /* Ligeramente más pequeño */
            line-height: 1.5; /* Mejor espaciado de línea */
            /* Considerar añadir overflow-y: auto si el contenido puede ser muy largo */
        }
        #history-list {
            max-height: 350px; /* Un poco más alto */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 10px; /* Menos padding exterior */
            border-radius: 4px;
            background-color: var(--background-color); /* Fondo del body */
        }
        .history-item {
            background-color: var(--card-bg);
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 10px; /* Menos espacio entre items */
            border-radius: 4px;
            cursor: pointer;
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
            position: relative; /* Para posible futuro icono de borrar */
        }
        .history-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color); /* Resaltar al pasar el ratón */
        }
        .history-item strong {
            display: block;
            margin-bottom: 5px;
            color: var(--primary-color);
            font-size: 0.9em;
            font-weight: 600;
        }
        .history-item p { /* Para el snippet del resultado */
            margin: 5px 0;
            font-size: 0.9em;
            color: #555;
            max-height: 60px; /* Limitar altura */
            overflow: hidden;
            text-overflow: ellipsis;
            /* white-space: pre-wrap; No es ideal para snippets */
            word-wrap: break-word;
            line-height: 1.4;
        }
        .history-meta {
            font-size: 0.8em;
            color: var(--secondary-color);
            margin-top: 10px;
            border-top: 1px dashed var(--border-color); /* Separador */
            padding-top: 8px;
        }
        .history-item .truncated-indicator { /* Estilo para el indicador de truncado */
            color: var(--warning-color);
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 5px;
        }

        /* --- Indicadores de Carga y Mensajes --- */
        #loading {
            display: none;
            text-align: center;
            margin: 25px 0;
            font-weight: bold;
            color: var(--secondary-color);
            font-style: italic;
            /* aria-live="polite" añadido en HTML */
        }
        #error-message, #warning-message {
            padding: 12px 15px;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
            font-size: 0.95em;
            border: 1px solid transparent;
            /* aria-live="polite" añadido en HTML */
        }
        #error-message {
            color: #721c24; /* Texto oscuro para contraste */
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        #warning-message {
            color: #856404; /* Texto oscuro */
            background-color: #fff3cd;
            border-color: #ffeeba;
        }

        /* --- Contenedor y Valor del Slider de Longitud --- */
        .length-container {
            display: flex;
            align-items: center;
            gap: 15px; /* Espacio entre slider y valor */
        }
        .length-container input[type="range"] {
            flex-grow: 1;
            margin: 0; /* Quitar margen por defecto */
        }
        #length-value {
            font-weight: bold;
            color: var(--primary-color);
            background-color: #e9ecef; /* Fondo para resaltar */
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            min-width: 90px; /* Ancho mínimo */
            text-align: center;
            white-space: nowrap;
        }

        /* --- Estilos Responsivos --- */
        @media (max-width: 768px) {
             .container { padding: 20px; }
             h1 { font-size: 1.9em; }
             h2 { font-size: 1.4em; }
             .api-key-input-wrapper { flex-direction: column; align-items: stretch; }
             .api-key-section button { width: 100%; margin-top: 5px; margin-right: 0; }
             .length-container { flex-direction: column; align-items: flex-start; gap: 10px;}
             .length-container input[type="range"] { width: 100%; }
             #length-value { margin-top: 5px; width: 100%; text-align: left;}
        }

        @media (max-width: 600px) {
             body { padding: 10px; }
             .container { padding: 15px; }
             h1 { font-size: 1.7em; }
             h2 { font-size: 1.3em; }
             textarea { min-height: 100px; }
             #result { min-height: 200px; }
             button { width: 100%; margin-right: 0; margin-bottom: 10px; } /* Botones apilados */
             .button-group { display: flex; flex-direction: column; gap: 10px; margin-top: 10px;}
             .button-group button { margin-bottom: 0; } /* Quitar margen inferior extra */
             .api-key-input-wrapper { gap: 5px; }
             .api-key-section button { margin-top: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <svg class="title-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M19.04 6.96C17.71 5.68 15.94 5 14 5c-1.94 0-3.71.68-5.04 1.96C7.68 8.29 7 10.06 7 12s.68 3.71 1.96 5.04C10.29 18.32 12.06 19 14 19s3.71-.68 5.04-1.96C20.32 15.71 21 13.94 21 12s-.68-3.71-1.96-5.04zM14 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm-1-8v4h2V9h-2zm0 6v2h2v-2h-2z" fill-rule="evenodd"/>
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10h5v-2h-5c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8v1.43c.9.44 1.5 1.39 1.5 2.57 0 1.66-1.34 3-3 3h-2.5c-.83 0-1.5-.67-1.5-1.5S15.67 16 16.5 16H18v-2h-1.5c-1.93 0-3.5 1.57-3.5 3.5s1.57 3.5 3.5 3.5H20c2.76 0 5-2.24 5-5 0-2.05-1.23-3.81-3-4.58V12c0-5.52-4.48-10-10-10z" opacity=".3"/>
            </svg>
            Phrase Forge
        </h1>

        <div class="api-key-section">
            <label for="api-key-input">Clave API de OpenRouter:</label>
            <div class="api-key-input-wrapper">
                <input type="password" id="api-key-input" placeholder="Introduce tu clave API (sk-or-v1-...)">
                <button id="save-key-btn">Guardar Clave</button>
                <button id="clear-key-btn">Borrar Clave</button>
            </div>
            <div id="api-key-status" aria-live="polite">Introduce tu clave para activar la generación. La clave se guarda localmente.</div>
            <p>
                Consigue tu clave en <a href="https://openrouter.ai/keys" target="_blank" rel="noopener noreferrer">OpenRouter</a>.
                Phrase Forge necesita una clave válida para generar texto.
            </p>
        </div>

        <p>Genera texto de alta calidad en múltiples estilos e idiomas usando IA. Ajusta el deslizador para la longitud deseada de la *próxima* generación. Los resultados se añadirán abajo.</p>

        <div class="input-section">
            <div class="form-group">
                <label for="prompt">Introduce tu Instrucción (Prompt):</label>
                <textarea id="prompt" placeholder="Ej: Escribe una historia corta sobre un robot perdido encontrando su camino a casa"></textarea>
            </div>

            <div class="form-group">
                <label for="model-select">Modelo de Lenguaje:</label>
                <select id="model-select">
                    <option value="" selected disabled>-- Selecciona un Modelo --</option>
                    <option value="meta-llama/llama-3-8b-instruct:free">Llama 3 8B Instruct (Free)</option>
                    <option value="google/gemini-flash-1.5">Google Gemini Flash 1.5</option>
                    <option value="mistralai/mistral-7b-instruct:free">Mistral 7B Instruct (Free)</option>
                    <option value="openai/gpt-3.5-turbo">OpenAI GPT-3.5 Turbo</option>
                    <option value="anthropic/claude-3-haiku">Anthropic Claude 3 Haiku</option>
                    </select>
            </div>

            <div class="form-group">
                <label for="style">Estilo de Escritura:</label>
                <select id="style">
                    <option value="Formal">Formal</option>
                    <option value="Informal">Informal</option>
                    <option value="Persuasive">Persuasivo</option>
                    <option value="Descriptive">Descriptivo</option>
                    <option value="Narrative" selected>Narrativo</option>
                    <option value="Technical">Técnico</option>
                    <option value="Humorous">Humorístico</option>
                    <option value="Poetic">Poético</option>
                    <option value="Horror">Terror</option>
                 </select>
            </div>

            <div class="form-group">
                <label for="language">Idioma:</label>
                <select id="language">
                    <option value="Spanish">Español</option>
                    <option value="Catalan">Catalán</option>
                    <option value="English" selected>Inglés</option>
                    <option value="French">Francés</option>
                    <option value="German">Alemán</option>
                    <option value="Italian">Italiano</option>
                    <option value="Portuguese">Portugués</option>
                    <option value="Russian">Ruso</option>
                    <option value="Chinese">Chino</option>
                    <option value="Japanese">Japonés</option>
                    <option value="Korean">Coreano</option>
                 </select>
            </div>

            <div class="form-group">
                <label for="length">Longitud para la Próxima Generación (palabras aprox.):</label>
                <div class="length-container">
                    <input type="range" id="length" min="50" max="1000" step="10" value="200">
                    <span id="length-value">200 palabras</span>
                </div>
             </div>

            <button id="generate-btn" disabled>Generar y Añadir Texto</button>
            <div id="loading" aria-live="polite">Generando... Por favor, espera...</div>
            <div id="error-message" aria-live="polite"></div>
            <div id="warning-message" aria-live="polite"></div>
        </div>

        <div class="result-section">
            <h2>Área de Resultado</h2>
            <textarea id="result" placeholder="Introduce tu clave API arriba, selecciona un modelo, luego genera texto. El texto generado por IA se añadirá aquí..." readonly></textarea>
            <div class="button-group">
                <button id="copy-result-btn" disabled>Copiar Texto</button>
                <button id="export-btn" disabled>Exportar como .txt</button>
                <button id="clear-result-btn" disabled>Limpiar Área</button>
            </div>
        </div>

        <div class="history-section">
            <h2>Historial de Generaciones (Individuales)</h2>
            <div id="history-list"><p>Aún no se han registrado generaciones individuales.</p></div>
            <button id="clear-history-btn" disabled>Limpiar Historial</button>
        </div>
    </div>

    <script>
        // --- Configuración Global ---
        const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        // ELIMINADO: const MODEL = '...'; // El modelo ahora se selecciona desde el HTML
        const MAX_HISTORY_ITEMS = 25; // Máximo de elementos a guardar en el historial
        const MAX_TOKENS_LIMIT = 4000; // Límite superior de tokens para la API (ajustar según modelo si es necesario)
        const WORD_TO_TOKEN_RATIO = 0.6; // Estimación para convertir palabras a tokens (puede variar por idioma/modelo)
        const API_KEY_STORAGE_KEY = 'phraseForgeApiKey'; // Clave para guardar la API key en localStorage
        const HISTORY_STORAGE_KEY = 'phraseForgeHistory'; // Clave para guardar el historial en localStorage

        // --- Referencias a Elementos del DOM (Cache para eficiencia) ---
        const apiKeyInput = document.getElementById('api-key-input');
        const saveKeyBtn = document.getElementById('save-key-btn');
        const clearKeyBtn = document.getElementById('clear-key-btn');
        const apiKeyStatus = document.getElementById('api-key-status');
        const promptEl = document.getElementById('prompt');
        const modelSelectEl = document.getElementById('model-select'); // NUEVO: Referencia al selector de modelo
        const styleEl = document.getElementById('style');
        const languageEl = document.getElementById('language');
        const lengthEl = document.getElementById('length');
        const lengthValueEl = document.getElementById('length-value');
        const generateBtn = document.getElementById('generate-btn');
        const loadingEl = document.getElementById('loading');
        const errorMessageEl = document.getElementById('error-message');
        const warningMessageEl = document.getElementById('warning-message');
        const resultEl = document.getElementById('result');
        const copyResultBtn = document.getElementById('copy-result-btn');
        const exportBtn = document.getElementById('export-btn');
        const clearResultBtn = document.getElementById('clear-result-btn');
        const historyListEl = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');

        // --- Estado Interno de la Aplicación ---
        let currentApiKey = null; // Almacena la clave API actual
        let isGenerating = false; // Flag para evitar llamadas múltiples a la API

        // --- Funciones de Utilidad ---

        /**
         * Escapa caracteres HTML para prevenir XSS básico al mostrar contenido del usuario.
         * @param {string} unsafe - La cadena potencialmente insegura.
         * @returns {string} La cadena escapada.
         */
        const escapeHtml = (unsafe) => {
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        };

        // --- Gestión de la Clave API ---

        /** Carga la clave API desde localStorage al iniciar. */
        function loadApiKey() {
            const storedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (storedKey) {
                currentApiKey = storedKey;
                apiKeyInput.value = currentApiKey; // Rellenar el input (aunque sea tipo password)
                apiKeyStatus.textContent = 'Clave API cargada desde almacenamiento local.';
                apiKeyStatus.style.color = 'var(--success-color)';
            } else {
                apiKeyStatus.textContent = 'Introduce tu clave API de OpenRouter para activar la generación.';
                apiKeyStatus.style.color = 'var(--secondary-color)';
            }
            updateApiKeyButtonsState(); // Actualizar estado de botones Guardar/Borrar
            updateGenerateButtonState(); // Actualizar estado del botón Generar (depende de clave y modelo)
        }

        /** Guarda la clave API introducida en localStorage. */
        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            // Validación simple: debe empezar con 'sk-or-v1-'
            if (key && key.startsWith('sk-or-v1-')) {
                currentApiKey = key;
                localStorage.setItem(API_KEY_STORAGE_KEY, currentApiKey);
                apiKeyStatus.textContent = '¡Clave API guardada correctamente!';
                apiKeyStatus.style.color = 'var(--success-color)';
                hideMessage('error'); // Ocultar errores previos si se guarda bien
            } else {
                showError("Formato de clave API inválido. Debe empezar con 'sk-or-v1-'.");
                currentApiKey = null; // Invalidar clave si el formato es incorrecto
            }
            updateApiKeyButtonsState();
            updateGenerateButtonState();
        }

        /** Borra la clave API de localStorage. */
        function clearApiKey() {
            if (confirm('¿Estás seguro de que quieres borrar la clave API guardada? Esta acción no se puede deshacer.')) {
                currentApiKey = null;
                localStorage.removeItem(API_KEY_STORAGE_KEY);
                apiKeyInput.value = '';
                apiKeyStatus.textContent = 'Clave API borrada. Introduce una clave para activar la generación.';
                apiKeyStatus.style.color = 'var(--secondary-color)';
                updateApiKeyButtonsState();
                updateGenerateButtonState(); // El botón de generar se deshabilitará
            }
        }

        /** Actualiza el estado (habilitado/deshabilitado) de los botones Guardar/Borrar clave. */
         function updateApiKeyButtonsState() {
             const keyExists = !!localStorage.getItem(API_KEY_STORAGE_KEY);
             // Deshabilitar Borrar si no hay clave o si se está generando
             clearKeyBtn.disabled = !keyExists || isGenerating;
             // Deshabilitar Guardar solo si se está generando
             saveKeyBtn.disabled = isGenerating;
             // Deshabilitar el input de la clave durante la generación
             apiKeyInput.disabled = isGenerating;
         }

        // --- Gestión del Estado del Botón de Generación ---

        /**
         * Habilita o deshabilita el botón "Generar" basado en si hay una clave API válida
         * y si se ha seleccionado un modelo. También considera si una generación está en curso.
         */
         function updateGenerateButtonState() {
             const modelSelected = modelSelectEl.value && modelSelectEl.value !== ""; // Verifica que no sea el placeholder
             generateBtn.disabled = isGenerating || !currentApiKey || !modelSelected;
         }


        // --- Actualizaciones de la Interfaz de Usuario (UI) ---

        /** Actualiza el texto que muestra el valor actual del slider de longitud. */
        function updateLengthDisplay() {
            lengthValueEl.textContent = `${lengthEl.value} palabras`;
        }

        /**
         * Muestra u oculta el indicador de carga y habilita/deshabilita los controles del formulario.
         * @param {boolean} isLoading - True para mostrar carga, false para ocultarla.
         */
        function showLoading(isLoading) {
            isGenerating = isLoading; // Actualizar el estado global
            loadingEl.style.display = isLoading ? 'block' : 'none';

            // Deshabilitar/habilitar controles principales durante la carga
            promptEl.disabled = isLoading;
            modelSelectEl.disabled = isLoading; // Deshabilitar selector de modelo
            styleEl.disabled = isLoading;
            languageEl.disabled = isLoading;
            lengthEl.disabled = isLoading;

            updateGenerateButtonState(); // Actualizar estado del botón Generar
            updateApiKeyButtonsState(); // Actualizar estado de botones de API key
            updateResultButtonsState(); // Actualizar estado de botones de resultado
            updateHistoryButtonsState(); // Actualizar estado de botones de historial

            // Ocultar mensajes de error/advertencia al iniciar una nueva carga
            if (isLoading) {
                hideMessage('error');
                hideMessage('warning');
            }
        }

        /** Muestra un mensaje de error. */
        function showError(message) {
            errorMessageEl.textContent = `Error: ${message}`;
            errorMessageEl.style.display = 'block';
            hideMessage('warning'); // Ocultar advertencia si se muestra un error
        }

        /** Muestra un mensaje de advertencia. */
        function showWarning(message) {
            warningMessageEl.textContent = `Advertencia: ${message}`;
            warningMessageEl.style.display = 'block';
            hideMessage('error'); // Ocultar error si se muestra una advertencia
        }

        /** Oculta un tipo específico de mensaje (error o warning). */
        function hideMessage(type) {
            if (type === 'error') {
                errorMessageEl.style.display = 'none';
                errorMessageEl.textContent = '';
            } else if (type === 'warning') {
                warningMessageEl.style.display = 'none';
                warningMessageEl.textContent = '';
            }
        }

        // --- Gestión del Historial ---

        /** Carga el historial desde localStorage y lo muestra. */
        function loadHistory() {
            const history = getHistoryFromStorage();
            displayHistory(history);
            updateHistoryButtonsState(); // Actualizar botón Limpiar Historial
        }

        /** Obtiene el historial parseado desde localStorage. */
        function getHistoryFromStorage() {
            const storedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
            try {
                // Devuelve el array parseado o uno vacío si no hay nada o hay error
                return storedHistory ? JSON.parse(storedHistory) : [];
            } catch (e) {
                console.error("Error al parsear el historial desde localStorage:", e);
                localStorage.removeItem(HISTORY_STORAGE_KEY); // Limpiar si está corrupto
                return [];
            }
        }

        /** Guarda el array del historial en localStorage. */
        function saveHistoryToStorage(history) {
            try {
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
            } catch (e) {
                 console.error("Error al guardar el historial en localStorage:", e);
                 showError("No se pudo guardar el historial, posiblemente el almacenamiento está lleno.");
            }
        }

        /**
         * Añade un nuevo elemento al historial (al principio) y lo guarda.
         * @param {object} item - El objeto de historial a añadir.
         */
        function addToHistory(item) {
            const history = getHistoryFromStorage();
            history.unshift(item); // Añadir al inicio para que los más nuevos aparezcan arriba

            // Limitar el número de elementos en el historial
            if (history.length > MAX_HISTORY_ITEMS) {
                history.pop(); // Eliminar el elemento más antiguo (del final)
            }

            saveHistoryToStorage(history);
            displayHistory(history); // Actualizar la visualización
            updateHistoryButtonsState(); // Asegurar que el botón Limpiar esté habilitado
        }

        /** Muestra los elementos del historial en la lista. */
        function displayHistory(history) {
            historyListEl.innerHTML = ''; // Limpiar la lista actual
            if (history.length === 0) {
                historyListEl.innerHTML = '<p>Aún no se han registrado generaciones individuales.</p>';
                return; // No hacer nada más si no hay historial
            }

            history.forEach((item, index) => {
                const div = document.createElement('div');
                div.classList.add('history-item');
                div.dataset.index = index; // Guardar índice para saber cuál cargar al hacer clic

                // Extraer y formatear datos del item de historial (con valores por defecto)
                const timestamp = item?.timestamp ? new Date(item.timestamp).toLocaleString('es-ES') : 'N/A'; // Formato local
                const promptSnippet = item?.prompt ? escapeHtml(item.prompt.substring(0, 100)) + (item.prompt.length > 100 ? '...' : '') : '[Sin Prompt]';
                const resultSnippet = item?.result ? escapeHtml(item.result.substring(0, 150)) + (item.result.length > 150 ? '...' : '') : '[Sin Resultado]';
                const modelUsed = item?.model ? escapeHtml(item.model) : 'N/A'; // Mostrar modelo usado
                const style = item?.style ? escapeHtml(item.style) : 'N/A';
                const language = item?.language ? escapeHtml(item.language) : 'N/A';
                const lengthReq = item?.length ? item.length : 'N/A';
                const finishReason = item?.finish_reason; // Razón por la que finalizó la generación

                // Añadir indicador visual si la generación pudo ser truncada por longitud
                const truncatedIndicator = (finishReason === 'length' || finishReason === 'max_tokens')
                    ? '<span class="truncated-indicator">(Podría estar truncado)</span>'
                    : '';

                // Construir el HTML interno del elemento de historial
                div.innerHTML = `
                    <strong>Prompt:</strong> ${promptSnippet}
                    <p><strong>Fragmento del Resultado:</strong> ${resultSnippet}${truncatedIndicator}</p>
                    <div class="history-meta">Modelo: ${modelUsed} | Estilo: ${style} | Idioma: ${language} | Longitud Solicitada: ${lengthReq} palabras | ${timestamp}</div>
                `;

                // Añadir evento para cargar este item al hacer clic
                div.addEventListener('click', () => loadHistoryItem(index));

                historyListEl.appendChild(div);
            });
        }

        /**
         * Carga los datos de un elemento del historial en los campos del formulario.
         * @param {number} index - El índice del elemento a cargar.
         */
        function loadHistoryItem(index) {
             const allHistory = getHistoryFromStorage();
             if (index >= 0 && index < allHistory.length) {
                 const item = allHistory[index];
                 // Rellenar los campos del formulario
                 promptEl.value = item.prompt || '';
                 modelSelectEl.value = item.model || ''; // Cargar el modelo guardado
                 styleEl.value = item.style || 'Narrative'; // Usar valor por defecto si no existe
                 languageEl.value = item.language || 'English';
                 lengthEl.value = item.length || 200;
                 updateLengthDisplay(); // Actualizar el display del slider

                 // Mostrar el resultado completo de ese historial en el área principal
                 resultEl.value = item.result || '';

                 updateResultButtonsState(); // Actualizar botones Copiar/Exportar/Limpiar resultado
                 updateGenerateButtonState(); // Actualizar botón Generar (puede que ahora esté habilitado)

                 // Opcional: Hacer scroll hacia arriba para ver los campos rellenados
                 window.scrollTo({ top: 0, behavior: 'smooth' });
             }
        }

        /** Borra todo el historial de localStorage. */
        function clearHistory() {
            if (confirm('¿Estás seguro de que quieres borrar TODO el historial de generaciones? Esta acción no se puede deshacer.')) {
                localStorage.removeItem(HISTORY_STORAGE_KEY);
                loadHistory(); // Recargar para mostrar la lista vacía y actualizar botones
            }
        }

        /** Actualiza el estado del botón "Limpiar Historial". */
        function updateHistoryButtonsState() {
             const historyExists = getHistoryFromStorage().length > 0;
             clearHistoryBtn.disabled = !historyExists || isGenerating;
        }


        // --- Funciones Relacionadas con el Área de Resultado ---

        /**
         * Añade nuevo texto al área de resultado, separándolo del anterior.
         * @param {string} newText - El texto generado a añadir.
         */
        function updateResultDisplay(newText) {
            // Añadir separador si ya hay contenido previo
            resultEl.value += (resultEl.value ? '\n\n---\n\n' : '') + newText;
            // Hacer scroll automático al final para ver el nuevo texto
            resultEl.scrollTop = resultEl.scrollHeight;
            updateResultButtonsState(); // Habilitar botones de resultado
        }

        /** Limpia el contenido del área de resultado. */
        function clearResultArea() {
             if (confirm('¿Estás seguro de que quieres limpiar el área de resultado?')) {
                resultEl.value = '';
                updateResultButtonsState(); // Deshabilitar botones de resultado
             }
        }

        /** Copia el contenido del área de resultado al portapapeles. */
        function copyResultText() {
            if (!resultEl.value) return; // No hacer nada si está vacío
            navigator.clipboard.writeText(resultEl.value)
                .then(() => {
                    // Feedback visual temporal al usuario
                    const originalText = copyResultBtn.textContent;
                    copyResultBtn.textContent = '¡Copiado!';
                    copyResultBtn.style.backgroundColor = 'var(--success-color)';
                    setTimeout(() => {
                        copyResultBtn.textContent = originalText;
                        // Volver al color original del botón (asumiendo que era el primario)
                        copyResultBtn.style.backgroundColor = 'var(--primary-color)';
                    }, 2000); // Mostrar mensaje por 2 segundos
                })
                .catch(err => {
                    console.error('Error al copiar texto: ', err);
                    showError('No se pudo copiar el texto al portapapeles.');
                });
        }

        /** Exporta el contenido del área de resultado como un archivo .txt. */
        function exportResultAsTxt() {
             if (!resultEl.value) return; // No hacer nada si está vacío
             // Crear un Blob (objeto binario) con el texto
             const blob = new Blob([resultEl.value], { type: 'text/plain;charset=utf-8' });
             // Crear un enlace temporal para la descarga
             const link = document.createElement('a');
             link.href = URL.createObjectURL(blob);
             // Crear un nombre de archivo dinámico con fecha y hora
             const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
             link.download = `phrase_forge_result_${timestamp}.txt`;
             // Simular clic en el enlace para iniciar la descarga
             document.body.appendChild(link); // Necesario para Firefox
             link.click();
             // Limpiar el enlace temporal
             document.body.removeChild(link);
             URL.revokeObjectURL(link.href); // Liberar el objeto URL
        }

        /** Actualiza el estado de los botones del área de resultado (Copiar, Exportar, Limpiar). */
        function updateResultButtonsState() {
            const hasResult = resultEl.value.trim().length > 0;
            copyResultBtn.disabled = !hasResult || isGenerating;
            exportBtn.disabled = !hasResult || isGenerating;
            clearResultBtn.disabled = !hasResult || isGenerating;
        }

        // --- Lógica Principal: Generación de Texto ---

        /** Función asíncrona que llama a la API de OpenRouter para generar texto. */
        async function generateText() {
            // 1. Validaciones Previas
            if (!currentApiKey) {
                showError("Por favor, introduce y guarda tu clave API de OpenRouter primero.");
                apiKeyInput.focus(); // Poner foco en el input de la clave
                return;
            }
            const prompt = promptEl.value.trim();
            const selectedModel = modelSelectEl.value; // Obtener el modelo seleccionado
            if (!prompt) {
                showError("Por favor, introduce una instrucción (prompt).");
                promptEl.focus();
                return;
            }
            if (!selectedModel) { // Validar que se ha seleccionado un modelo
                showError("Por favor, selecciona un modelo de lenguaje.");
                modelSelectEl.focus();
                return;
            }

            // 2. Iniciar Estado de Carga
            showLoading(true);

            // 3. Recopilar Parámetros
            const style = styleEl.value;
            const language = languageEl.value;
            const requestedLength = parseInt(lengthEl.value, 10);

            // Calcular 'max_tokens' basado en la longitud deseada (heurística)
            // y asegurarse de no exceder el límite global MAX_TOKENS_LIMIT
            const calculatedTokens = Math.round(requestedLength / WORD_TO_TOKEN_RATIO);
            const maxTokens = Math.min(calculatedTokens, MAX_TOKENS_LIMIT);

            // 4. Construir Mensajes para la API (System y User)
            const systemPrompt = `You are a helpful writing assistant. Generate text following the user's instructions. The user wants the output in a ${style} style and in ${language}. Aim for a length of approximately ${requestedLength} words.`;
            const userPrompt = prompt;

            // 5. Llamada a la API (Fetch)
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentApiKey}`,
                        // Cabeceras requeridas/recomendadas por OpenRouter
                        'HTTP-Referer': window.location.href, // Enviar la URL actual
                        'X-Title': 'Phrase Forge', // Nombre de tu aplicación
                    },
                    body: JSON.stringify({
                        model: selectedModel, // Usar el modelo seleccionado del desplegable
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ],
                        max_tokens: maxTokens,
                        // Se pueden añadir otros parámetros como temperature, top_p, etc.
                        // temperature: 0.7,
                    })
                });

                // 6. Manejo de la Respuesta
                if (!response.ok) {
                    // Intentar obtener detalles del error del cuerpo de la respuesta
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { message: response.statusText }; // Usar texto de estado si no hay JSON
                    }
                    // Construir mensaje de error detallado
                    const errorMsg = `Error ${response.status}: ${errorData?.error?.message || errorData.message || 'Error desconocido de la API'}`;
                    console.error("API Error Data:", errorData); // Loguear detalles para depuración
                    throw new Error(errorMsg); // Lanzar error para ser capturado por el catch
                }

                // Si la respuesta es OK (2xx)
                const data = await response.json();

                // Extraer el texto generado y la razón de finalización
                const generatedText = data.choices?.[0]?.message?.content?.trim();
                const finishReason = data.choices?.[0]?.finish_reason; // e.g., 'stop', 'length'

                if (generatedText) {
                    // 7. Actualizar UI y Guardar en Historial
                    updateResultDisplay(generatedText); // Añadir texto al área de resultado

                    addToHistory({
                        prompt: prompt,
                        result: generatedText,
                        model: selectedModel, // Guardar el modelo que se usó
                        style: style,
                        language: language,
                        length: requestedLength,
                        timestamp: new Date().toISOString(),
                        finish_reason: finishReason // Guardar por qué terminó
                    });

                    // Mostrar advertencia si la generación fue truncada
                    if (finishReason === 'length' || finishReason === 'max_tokens') {
                         showWarning(`La generación puede haberse detenido antes de completarse debido al límite de longitud (max_tokens: ${maxTokens}). Considera usar un prompt más corto o ajustar la longitud deseada.`);
                    } else {
                         hideMessage('warning'); // Ocultar advertencias si la generación fue normal
                    }
                    hideMessage('error'); // Ocultar errores si la generación fue exitosa

                } else {
                    // Caso raro donde la respuesta es OK pero no hay texto
                    throw new Error("La respuesta de la API fue exitosa pero no contenía texto generado.");
                }

            } catch (error) {
                // 8. Manejo de Errores (de red o de la API)
                console.error('Error durante la generación:', error);
                showError(error.message || "Ocurrió un error inesperado al contactar la API.");
            } finally {
                // 9. Finalizar Estado de Carga (siempre se ejecuta)
                showLoading(false);
            }
        }

        // --- Asignación de Event Listeners ---
        lengthEl.addEventListener('input', updateLengthDisplay); // Actualizar valor de longitud al mover slider
        generateBtn.addEventListener('click', generateText); // Generar texto al hacer clic
        saveKeyBtn.addEventListener('click', saveApiKey); // Guardar clave
        clearKeyBtn.addEventListener('click', clearApiKey); // Borrar clave
        copyResultBtn.addEventListener('click', copyResultText); // Copiar resultado
        exportBtn.addEventListener('click', exportResultAsTxt); // Exportar resultado
        clearResultBtn.addEventListener('click', clearResultArea); // Limpiar resultado
        clearHistoryBtn.addEventListener('click', clearHistory); // Limpiar historial
        modelSelectEl.addEventListener('change', updateGenerateButtonState); // Actualizar botón al cambiar modelo

        // --- Inicialización al Cargar la Página ---
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKey(); // Cargar clave API si existe
            loadHistory(); // Cargar y mostrar historial
            updateLengthDisplay(); // Mostrar valor inicial del slider
            updateResultButtonsState(); // Establecer estado inicial de botones de resultado
            updateHistoryButtonsState(); // Establecer estado inicial de botones de historial
            updateGenerateButtonState(); // Establecer estado inicial del botón generar
        });

    </script>
</body>
</html>

